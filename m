Received: with ECARTIS (v1.0.0; list linux-mips); Wed, 08 Aug 2007 13:58:36 +0100 (BST)
Received: from mx2.suse.de ([195.135.220.15]:64135 "EHLO mx2.suse.de")
	by ftp.linux-mips.org with ESMTP id S20026881AbXHHM61 (ORCPT
	<rfc822;linux-mips@linux-mips.org>); Wed, 8 Aug 2007 13:58:27 +0100
Received: from Relay1.suse.de (mail2.suse.de [195.135.221.8])
	(using TLSv1 with cipher DHE-RSA-AES256-SHA (256/256 bits))
	(No client certificate requested)
	by mx2.suse.de (Postfix) with ESMTP id 990A2219AA;
	Wed,  8 Aug 2007 14:57:21 +0200 (CEST)
Date:	Wed, 08 Aug 2007 14:57:19 +0200
Message-ID: <s5h3ayuyyj4.wl%tiwai@suse.de>
From:	Takashi Iwai <tiwai@suse.de>
To:	Ralf Baechle <ralf@linux-mips.org>
Cc:	Atsushi Nemoto <anemo@mba.ocn.ne.jp>, jiankemeng@gmail.com,
	tiansm@lemote.com, linux-mips@linux-mips.org,
	alsa-devel@alsa-project.org, greg@kroah.com
Subject: Re: ALSA on MIPS platform
In-Reply-To: <20070808115852.GA6700@linux-mips.org>
References: <46B332AC.8020403@lemote.com>
	<5861a7880708062253x7133659cm1ff17f451e4f82f8@mail.gmail.com>
	<5861a7880708062317t21970c81w3f16580858bf50af@mail.gmail.com>
	<20070807.230157.59463765.anemo@mba.ocn.ne.jp>
	<20070807175402.GA24731@linux-mips.org>
	<s5hlkcnmbll.wl%tiwai@suse.de>
	<20070808115852.GA6700@linux-mips.org>
User-Agent: Wanderlust/2.15.5 (Almost Unreal) SEMI/1.14.6 (Maruoka)
 FLIM/1.14.7 (=?ISO-8859-4?Q?Sanj=F2?=) APEL/10.6 MULE XEmacs/21.5 (beta27)
 (fiddleheads) (+CVS-20060704) (i386-suse-linux)
MIME-Version: 1.0 (generated by SEMI 1.14.6 - "Maruoka")
Content-Type: text/plain; charset=US-ASCII
Return-Path: <tiwai@suse.de>
X-Envelope-To: <"|/home/ecartis/ecartis -s linux-mips"> (uid 0)
X-Orcpt: rfc822;linux-mips@linux-mips.org
Original-Recipient: rfc822;linux-mips@linux-mips.org
X-archive-position: 16132
X-ecartis-version: Ecartis v1.0.0
Sender: linux-mips-bounce@linux-mips.org
Errors-to: linux-mips-bounce@linux-mips.org
X-original-sender: tiwai@suse.de
Precedence: bulk
X-list: linux-mips

At Wed, 8 Aug 2007 12:58:52 +0100,
Ralf Baechle wrote:
> 
> On Tue, Aug 07, 2007 at 08:41:10PM +0200, Takashi Iwai wrote:
> 
> > > It's ALSA that is doing funny things here so there is no point in fixing
> > > the arch code to work for ALSA.
> > 
> > Yep, but OTOH, the arch code doesn't provide a proper standard way to
> > mmap the pages allocated via dma_alloc_coherent().  That's the missing
> > piece, especially on mips and sparc.  ARM has already one.
> > 
> > My wish is implementing dma_mmap_coherent() on all architectures, so
> > that the driver can use it safely without messy ifdefs.
> 
> Adding dma_mmap_coherent has been proposed in 2004 but the discussion for
> some reason went nowhere because it apparently isn't implementable on
> PARISC due to cache synonyms - on MIPS we'd solve those issues where they
> exist by using uncached or writethrough mappings, as apropriate.

Actually, if it cannot be implemented (or not yet implemented
properly) on some architectures, it's fine.  Then we can simply drop
the mmap support just for such an architecture.  I suppose an inlined
dma_mmap_coherent() that always returns an error, just like the
earlier version of asm-generic/dma-mapping-broken.h, would work well.

But, currently, the driver has no idea which architecture is OK and
which not, and which method to choose.  That is where we got stuck.


Takashi
