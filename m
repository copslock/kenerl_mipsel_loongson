Received: (from majordomo@localhost)
	by oss.sgi.com (8.11.2/8.11.3) id g0HBabP09646
	for linux-mips-outgoing; Thu, 17 Jan 2002 03:36:37 -0800
Received: from nm.laser5.co.jp (nm.laser5.co.jp [202.221.8.75])
	by oss.sgi.com (8.11.2/8.11.3) with SMTP id g0HBaSP09641
	for <linux-mips@oss.sgi.com>; Thu, 17 Jan 2002 03:36:29 -0800
Received: from l5ac152.l5.laser5.co.jp (l5web.laser5.co.jp [202.221.8.76] (may be forged))
	by nm.laser5.co.jp (8.10.0/3.7WVER2000041120) with ESMTP id g0HB37L18637
	for <linux-mips@oss.sgi.com>; Thu, 17 Jan 2002 20:03:07 +0900
Date: Thu, 17 Jan 2002 19:36:24 +0900
Message-ID: <m3bsft6z87.wl@l5ac152.l5.laser5.co.jp>
From: Kunihiko IMAI <kimai@laser5.co.jp>
To: linux-mips@oss.sgi.com
Subject: Re: usb-problems with Au1000
In-Reply-To: <3C3DD208.45B5BC29@esk.fhg.de>
References: <3B7DA3A3.8010000@pacbell.net>
	<3C3DD208.45B5BC29@esk.fhg.de>
User-Agent: Wanderlust/2.4.0 (Rio) SEMI/1.13.7 (Awazu) CLIME/1.13.6
 (=?ISO-2022-JP?B?GyRCQ2YlTj4xGyhC?=) Emacs/20.7 (i386-laser5-linux-gnu)
 MULE/4.1 (AOI)
MIME-Version: 1.0 (generated by SEMI 1.13.7 - "Awazu")
Content-Type: text/plain; charset=US-ASCII
Sender: owner-linux-mips@oss.sgi.com
Precedence: bulk

Hi,

I'm trying SGI version of kernel-2.2.17.
And I get same message,

At Thu, 10 Jan 2002 18:40:24 +0100,
Wolfgang Heidrich wrote:

> hub.c: USB new device connect on bus1/1, assigned device number 3
> usb.c: USB device not accepting new address=3 (error=-145)

when connect some device.


I checked in some cases:

- Some devices are recognized, some are not.
	A joystick device (sanwa supply) works fine.
	A mouse device (century corp.) works too.
	But another mouse (Logitech Mini Wheel Mouse) doesn't work and
		I got message like above.

- When connected via USB hub device, Logitech mouse works fine.

I think USB root HUB doesn't work properly.


By the way:

today, I got a errata document from the chip dealer.  This document
reports some USB errata.
I read the report and source code, then  I found a bug in
arch/mips/au1000/pb1000/setup.c.


The errata report says workaround method:
- set the CPU clock is 384MHz
- set the source of USB host controller is CPU clcck.

And the code:

        /*
         * Setup 48MHz FREQ2 from CPUPLL for USB Host
         */
        /* FRDIV2=3 -> div by 8 of 384MHz -> 48MHz */
        sys_freqctrl |= ((3<<22) | (1<<21) | (0<<20));
        outl(sys_freqctrl, FQ_CNTRL_1);

Comment says "Setup FREQ2" but the code set FREQ5.

        outl(sys_freqctrl, FQ_CNTRL_1);

should be 

        outl(sys_freqctrl, FQ_CNTRL_0);

Also formar line:

	sys_freqctrl = inl(FQ_CNTRL_1);

should be

	sys_freqctrl = inl(FQ_CNTRL_0);


Thanks.
_._. __._  _ . ... _  .___ ._. _____ _... ._ _._ _.._. .____  _ . ... _

                                                          Kunihiko IMAI
